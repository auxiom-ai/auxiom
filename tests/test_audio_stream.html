<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Audio Test</title>
</head>
<body>
  <h1>WebSocket Audio Test</h1>
  <button id="connectButton">Connect to WebSocket</button>
  <p id="status">Status: Not connected</p>
  <audio id="audioPlayer" controls autoplay></audio>

  <script>
    const connectButton = document.getElementById("connectButton");
    const statusElement = document.getElementById("status");
    const audioPlayer = document.getElementById("audioPlayer");

    connectButton.addEventListener("click", () => {
      const userId = "33"; // Replace with your user ID
      const episode = "pickle_script"; // Replace with your episode
      const wsUrl = `ws://127.0.0.1:8000/ws/podcast/${userId}/${episode}`;
      const socket = new WebSocket(wsUrl);

      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const audioQueue = [];
      const bufferThreshold = 20; // Increase the buffer threshold to 20 chunks
      let isPlaying = false;

      const mediaSource = new MediaSource();
      audioPlayer.src = URL.createObjectURL(mediaSource);

      mediaSource.addEventListener("sourceopen", () => {
        const sourceBuffer = mediaSource.addSourceBuffer("audio/mpeg"); // Adjust MIME type if needed
        sourceBuffer.mode = "sequence";

        sourceBuffer.addEventListener("updateend", () => {
          if (audioQueue.length > 0) {
            appendNextChunk();
          }
        });
      });

      function appendNextChunk() {
        if (audioQueue.length === 0 || !sourceBuffer || sourceBuffer.updating) {
          return;
        }

        const chunk = audioQueue.shift();
        sourceBuffer.appendBuffer(chunk);
      }

      socket.onopen = () => {
        statusElement.textContent = "Status: Connected";
        console.log("WebSocket connection established");
      };

      socket.onmessage = async (event) => {
        if (event.data instanceof Blob) {
          console.log("Received audio chunk");
          const arrayBuffer = await event.data.arrayBuffer();
          audioQueue.push(arrayBuffer);

          // Start playback only when the buffer reaches the threshold
          if (!isPlaying && audioQueue.length >= bufferThreshold) {
            playAudioChunks();
          }
        } else {
          console.log("Received message:", event.data);
        }
      };

      socket.onclose = () => {
        statusElement.textContent = "Status: Disconnected";
        console.log("WebSocket connection closed");
      };

      socket.onerror = (error) => {
        console.error("WebSocket error:", error);
        statusElement.textContent = "Status: Error";
      };

      async function playAudioChunks() {
        if (audioQueue.length === 0) {
          isPlaying = false;
          return;
        }

        isPlaying = true;
        const chunk = audioQueue.shift();

        try {
          const audioBuffer = await audioContext.decodeAudioData(chunk);
          const source = audioContext.createBufferSource();
          source.buffer = audioBuffer;
          source.connect(audioContext.destination);
          source.start();

          source.onended = () => {
            playAudioChunks(); // Play the next chunk
          };
        } catch (error) {
          console.error("Error decoding audio chunk:", error);
          playAudioChunks(); // Skip to the next chunk
        }
      }
    });
  </script>
</body>
</html>
