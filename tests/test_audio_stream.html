<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Audio Test</title>
</head>
<body>
  <h1>WebSocket Audio Test</h1>
  <button id="connectButton">Connect to WebSocket</button>
  <p id="status">Status: Not connected</p>
  <audio id="audioPlayer" controls autoplay></audio>

  <script>
    const connectButton = document.getElementById("connectButton");
    const statusElement = document.getElementById("status");
    const audioPlayer = document.getElementById("audioPlayer");

    connectButton.addEventListener("click", () => {
      const userId = "33"; // Replace with your user ID
      const episode = "pickle_script"; // Replace with your episode
      const wsUrl = `ws://127.0.0.1:8000/ws/podcast/${userId}/${episode}`;
      const socket = new WebSocket(wsUrl);

      const mediaSource = new MediaSource();
      audioPlayer.src = URL.createObjectURL(mediaSource);
      let sourceBuffer;
      const audioQueue = [];
      const bufferThreshold = 20; // Keep a buffer to ensure smoother playback

      mediaSource.addEventListener("sourceopen", () => {
        // Replace with the actual MIME type of your audio stream
        sourceBuffer = mediaSource.addSourceBuffer("audio/mpeg");
        sourceBuffer.mode = "sequence";

        sourceBuffer.addEventListener("updateend", () => {
          if (audioQueue.length > 0 && !sourceBuffer.updating) {
            const nextChunk = audioQueue.shift();
            sourceBuffer.appendBuffer(nextChunk);
          } else if (audioQueue.length === 0 && mediaSource.readyState === "open") {
            // Optionally signal the end of stream if the server indicates it
            // mediaSource.endOfStream();
          }
        });

        sourceBuffer.addEventListener("error", (error) => {
          console.error("SourceBuffer error:", error);
          statusElement.textContent = "Status: Playback Error";
        });
      });

      mediaSource.addEventListener("sourceclose", () => {
        console.log("MediaSource closed");
      });

      socket.onopen = () => {
        statusElement.textContent = "Status: Connected";
        console.log("WebSocket connection established");
      };

      socket.onmessage = async (event) => {
        if (event.data instanceof Blob) {
          console.log("Received audio chunk");
          const arrayBuffer = await event.data.arrayBuffer();
          audioQueue.push(arrayBuffer);

          // Append to the source buffer if it's not updating and we have data
          if (sourceBuffer && !sourceBuffer.updating && audioQueue.length > 0) {
            const nextChunk = audioQueue.shift();
            sourceBuffer.appendBuffer(nextChunk);
          }
        } else {
          console.log("Received message:", event.data);
        }
      };

      socket.onclose = () => {
        statusElement.textContent = "Status: Disconnected";
        console.log("WebSocket connection closed");
        if (mediaSource.readyState === "open") {
          mediaSource.endOfStream();
        }
      };

      socket.onerror = (error) => {
        console.error("WebSocket error:", error);
        statusElement.textContent = "Status: Error";
        if (mediaSource.readyState === "open") {
          mediaSource.endOfStream("network");
        }
      };
    });
  </script>
</body>
</html>